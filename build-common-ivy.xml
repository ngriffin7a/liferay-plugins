<?xml version="1.0"?>
<!DOCTYPE project>

<project name="build-common-ivy" xmlns:antelope="antlib:ise.antelope.tasks" xmlns:ivy="antlib:org.apache.ivy.ant">
	<property name="ivy.home" value="${project.dir}/.ivy" />
	<property name="ivy.install.version" value="2.3.0" />

	<if>
		<not>
			<available file="${ivy.home}/ivy-${ivy.install.version}.jar" />
		</not>
		<then>
			<mkdir dir="${ivy.home}" />

			<get
				dest="${ivy.home}"
				src="http://repo2.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar"
			/>
		</then>
	</if>

	<path id="ivy.lib.path">
		<fileset
			dir="${ivy.home}"
			includes="ivy-${ivy.install.version}.jar"
		/>
		<fileset dir="${project.dir}/lib">
			<include name="bcpg-jdk16.jar" />
			<include name="bcprov-jdk16.jar" />
		</fileset>
	</path>

	<taskdef classpathref="ivy.lib.path" resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" />

	<basename file="${project.dir}" property="project.dir.name" />

	<for list="${basedir},${project.dir}" param="ivy.xml.dir">
		<sequential>
			<if>
				<available file="@{ivy.xml.dir}/ivy.xml" />
				<then>
					<pathconvert property="ivy.md5.dir">
						<map from="${project.dir}" to="${ivy.home}/${project.dir.name}" />

						<path location="@{ivy.xml.dir}"/>
					</pathconvert>

					<checksum file="@{ivy.xml.dir}/ivy.xml" todir="${ivy.md5.dir}" verifyproperty="ivy.xml.unmodified" />

					<if>
						<isfalse value="${ivy.xml.unmodified}" />
						<then>
							<ivy:settings file="${project.dir}/ivy-settings.xml" />

							<ivy:resolve
								file="@{ivy.xml.dir}/ivy.xml"
								log="download-only"
							/>

							<if>
								<or>
									<equals arg1="@{ivy.xml.dir}" arg2="${project.dir}" />
									<antelope:endswith string="${ant.project.name}" with="-shared" />
								</or>
								<then>
									<ivy:retrieve
										log="download-only"
										pattern="@{ivy.xml.dir}/lib/[artifact].[ext]"
										type="jar"
									/>
								</then>
								<else>
									<ivy:retrieve
										log="download-only"
										pattern="@{ivy.xml.dir}/docroot/WEB-INF/lib/[artifact].[ext]"
										type="jar"
									/>
								</else>
							</if>

							<checksum file="@{ivy.xml.dir}/ivy.xml" todir="${ivy.md5.dir}" />
						</then>
					</if>

					<var name="ivy.md5.dir" unset="true" />
					<var name="ivy.xml.unmodified" unset="true" />
				</then>
			</if>
		</sequential>
	</for>
	
	<target name="publish">

		<ivy:settings file="${project.dir}/ivy-settings.xml" />
		<ivy:resolve />

		<!-- Property defaults below can be overridden in the plugin's build.xml descriptor -->
		<property name="ivy.pom.developer" value="Brian Wing Shun Chan" />
		<property name="ivy.pom.description" value="${plugin.name}" />
		<property name="ivy.pom.name" value="${plugin.name}" />
		<property name="ivy.pom.template.filename" value="maven-central-plugin.pom" />
		<property name="ivy.pom.packaging" value="${plugin.packaging}" />
		<property name="ivy.pom.version" value="${plugin.full.version}${plugin.version.qualifier}" />

		<ivy:makepom
			description="${ivy.pom.description}"
			ivyfile="ivy.xml"
			pomfile="${plugin.pom.file}"
			templatefile="${project.dir}/tools/pom_tmpl/${ivy.pom.template.filename}">

			<mapping conf="compile" scope="compile" />
			<mapping conf="provided" scope="provided" />

		</ivy:makepom>

		<ivy:publish resolver="${ivy.publish.resolver}" forcedeliver="true" overwrite="true" publishivy="false">
			<artifacts pattern="${project.dir}/dist/${plugin.name}-${plugin.full.version}-[type].[ext]" />
			<artifacts pattern="${project.dir}/dist/${plugin.name}-${plugin.full.version}.[ext]" />
		</ivy:publish>

	</target>

	<target name="publish-local-m2-release">

		<antcall target="publish">
			<param name="ivy.publish.resolver" value="local-m2"/>
			<param name="plugin.version.qualifier" value="" />
		</antcall>

	</target>

	<target name="publish-local-m2-snapshot">

		<antcall target="publish">
			<param name="ivy.publish.resolver" value="local-m2"/>
			<param name="plugin.version.qualifier" value="-SNAPSHOT" />
		</antcall>

	</target>

	<target name="publish-central-m2-release">

		<antcall target="publish">
			<param name="ivy.publish.resolver" value="sonatype-m2-staging"/>
			<param name="plugin.version.qualifier" value="" />
		</antcall>

	</target>

	<target name="publish-central-m2-snapshot">

		<antcall target="publish">
			<param name="ivy.publish.resolver" value="sonatype-m2-snapshot"/>
			<param name="plugin.version.qualifier" value="-SNAPSHOT" />
		</antcall>

	</target>

</project>